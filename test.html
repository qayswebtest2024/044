<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مخابز الراية | طعم الأصالة</title>
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/2Sr4NfTj/465798-png5757.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

    <style>
        /* --- المتغيرات --- */
        :root {
            --primary: #d97706;
            --primary-dark: #b45309;
            --secondary: #fffbeb;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --white: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --font-main: 'Tajawal', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        /* ضبط حجم الخط لمنع الزوم في الآيفون */
        input, select, textarea { font-size: 16px !important; }

        body { font-family: var(--font-main); background-color: #f8f9fa; color: var(--text-main); padding-bottom: 90px; }
        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; font-family: inherit; border: none; }
        
        /* --- الهيدر --- */
        header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 1rem;
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .logo { display: flex; align-items: center; gap: 8px; font-size: 1.3rem; font-weight: 800; color: var(--primary); }
        .track-btn-header {
            background: var(--secondary); color: var(--primary-dark);
            padding: 8px 14px; border-radius: 50px; font-weight: 600; font-size: 0.85rem;
            display: flex; align-items: center; gap: 6px; border: 1px solid #fcd34d;
        }

        /* --- السلايدر --- */
        .swiper { width: 100%; height: 200px; margin-bottom: 15px; }
        @media(min-width: 768px) { .swiper { height: 350px; } }
        .swiper-slide { background-position: center; background-size: cover; display: flex; align-items: center; justify-content: center; }
        .slide-content {
            background: rgba(0,0,0,0.5); padding: 15px 25px; border-radius: 15px; 
            color: white; text-align: center; backdrop-filter: blur(3px);
        }
        .slide-content h2 { color: #fbbf24; margin-bottom: 5px; }

        /* --- التصنيفات --- */
        .categories-wrapper {
            position: sticky; top: 70px; z-index: 900;
            background: #f8f9fa; padding: 10px 0; margin-bottom: 10px;
        }
        .categories-filter {
            display: flex; gap: 10px; overflow-x: auto; padding: 5px 15px;
            scrollbar-width: none;
        }
        .categories-filter::-webkit-scrollbar { display: none; }
        .category-filter-btn {
            flex: 0 0 auto; background: white; color: var(--text-light);
            border: 1px solid #e5e7eb; padding: 8px 18px; border-radius: 50px;
            font-weight: 600; font-size: 0.9rem; transition: 0.2s;
        }
        .category-filter-btn.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(217, 119, 6, 0.2);
        }

        /* --- قائمة المنتجات (List View) --- */
        .products-container { padding: 0 15px; max-width: 1000px; margin: 0 auto; }
        .section-title { font-size: 1.3rem; margin-bottom: 15px; color: var(--text-main); padding-right: 10px; border-right: 4px solid var(--primary); }
        
        .products-grid { display: flex; flex-direction: column; gap: 12px; }
        @media(min-width: 768px) { .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; } }

        /* كارت المنتج */
        .product-card {
            background: white; border-radius: 12px; padding: 10px;
            display: flex; flex-direction: row; align-items: center; gap: 15px;
            box-shadow: var(--shadow); border: 1px solid white;
            transition: 0.2s; cursor: pointer; position: relative;
            z-index: 1; /* مستوى أساسي */
        }
        .product-card:active { transform: scale(0.98); }
        
        .product-image {
            width: 90px; height: 90px; border-radius: 10px; flex-shrink: 0;
            position: relative; overflow: hidden; background: #eee;
        }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        
        .product-details { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .product-name { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; color: var(--text-main); }
        .product-description { 
            font-size: 0.75rem; color: #888; margin-bottom: 8px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.3;
        }
        .product-footer { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .product-price { font-weight: 800; color: var(--primary); font-size: 1rem; }
        
        /* زر الإضافة السريع */
        .add-to-cart-btn-mini {
            width: 32px; height: 32px; border-radius: 8px;
            background: #f3f4f6; color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; transition: 0.2s;
            position: relative; z-index: 10; /* حل مشكلة عدم استجابة الزر */
        }
        .add-to-cart-btn-mini:hover { background: var(--primary); color: white; }

        /* --- السلة العائمة --- */
        .floating-cart {
            position: fixed; bottom: 85px; left: 20px;
            background: var(--text-main); color: white;
            width: 55px; height: 55px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 990; cursor: pointer; transition: 0.2s;
        }
        .floating-cart:active { transform: scale(0.9); }
        .cart-count {
            position: absolute; top: -2px; right: -2px;
            background: var(--danger); font-size: 0.7rem; width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid white; font-weight: bold;
        }

        /* --- الشريط السفلي الثابت --- */
        .sticky-checkout-btn {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 995; display: flex; justify-content: center;
        }
        .checkout-bar-inner {
            background: var(--primary); color: white;
            width: 100%; max-width: 600px;
            padding: 12px 20px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 1.1rem;
            cursor: pointer;
        }

        /* --- النوافذ المنبثقة (Modals) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: 0.3s; display: flex; justify-content: center; align-items: flex-end;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-sheet {
            background: white; width: 100%; max-width: 600px;
            border-radius: 20px 20px 0 0; padding: 20px;
            max-height: 85vh; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        @media(min-width: 768px) {
            .modal-overlay { align-items: center; }
            .modal-sheet { border-radius: 20px; transform: translateY(20px); max-height: 90vh; }
        }
        .modal-overlay.active .modal-sheet { transform: translateY(0); }

        /* تفاصيل المنتج داخل المودال */
        .product-detail-img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; }
        .product-detail-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 5px; }
        .product-detail-desc { color: #666; font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px; }
        .product-note-area {
            width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px;
            margin-bottom: 15px; resize: none; height: 80px; font-family: inherit;
            background: #f9f9f9;
        }
        .product-note-area:focus { border-color: var(--primary); background: white; }

        /* سلة المشتريات الجانبية */
        .cart-sidebar {
            position: fixed; top: 0; right: -100%; width: 100%; height: 100%;
            background: white; z-index: 2100; transition: right 0.3s ease;
            display: flex; flex-direction: column; max-width: 450px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .cart-sidebar.active { right: 0; }

        /* --- Checkout Form --- */
        .checkout-section {
            background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 15px;
            border: 1px solid #eee;
        }
        .checkout-section h3 { margin-bottom: 10px; color: var(--primary); font-size: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            transition: 0.2s; background: white;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1); }

        /* Toast */
        #toast-container { position: fixed; top: 20px; left: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: white; padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); font-weight: bold; font-size: 0.9rem;
            display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }

    </style>
</head>
<body>

    <header>
        <div class="logo">
            <i class="fas fa-bread-slice"></i>
            <span>مخابز الراية</span>
        </div>
        <div class="header-actions">
            <button class="track-btn-header" id="track-order-btn">
                <i class="fas fa-motorcycle"></i> تتبع
            </button>
        </div>
    </header>

    <div class="swiper">
        <div class="swiper-wrapper">
            <div class="swiper-slide" style="background-image: url('https://images.unsplash.com/photo-1509440159596-0249088772ff?q=80&w=800');">
                <div class="slide-content"><h2>طازج يومياً</h2></div>
            </div>
            <div class="swiper-slide" style="background-image: url('https://images.unsplash.com/photo-1555507036-ab1f4038808a?q=80&w=800');">
                <div class="slide-content"><h2>خصومات خاصة</h2></div>
            </div>
        </div>
        <div class="swiper-pagination"></div>
    </div>

    <div class="categories-wrapper">
        <div class="categories-filter" id="categories-filter"></div>
    </div>

    <div class="products-container">
        <h2 class="section-title">قائمة الطعام</h2>
        <div class="loading" id="loading"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>
        <div class="products-grid" id="products-grid"></div>
    </div>

    <div class="floating-cart" id="floating-cart">
        <span class="cart-count" id="floating-cart-count">0</span>
        <i class="fas fa-shopping-basket"></i>
    </div>
    
    <div class="sticky-checkout-btn" id="sticky-checkout-btn" style="display: none;">
        <div class="checkout-bar-inner" id="sticky-inner-btn">
            <span>إتمام الطلب <i class="fas fa-arrow-left"></i></span>
            <span id="sticky-cart-total">0.00 د.أ</span>
        </div>
    </div>

    <div class="modal-overlay" id="product-modal">
        <div class="modal-sheet">
            <button class="modal-close-btn" style="align-self: flex-end; background: #eee; width: 30px; height: 30px; border-radius: 50%;"><i class="fas fa-times"></i></button>
            <div id="modal-body"></div>
        </div>
    </div>

    <aside class="cart-sidebar" id="cart-sidebar">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-weight: 800;">سلة المشتريات</h3>
            <button id="cart-close" style="font-size: 1.2rem; padding: 5px;"><i class="fas fa-times"></i></button>
        </div>
        <div style="flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9;" id="cart-items-container">
            </div>
        <div style="padding: 15px; background: white; border-top: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem;">
                <span>المجموع:</span>
                <span id="cart-total-price">0.00 د.أ</span>
            </div>
            <button id="checkout-btn" style="width: 100%; padding: 14px; background: var(--text-main); color: white; border-radius: 12px; font-weight: bold;">تنفيذ الطلب</button>
        </div>
    </aside>

    <div class="modal-overlay" id="checkout-modal">
        <div class="modal-sheet">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h2 style="color: var(--primary);">تأكيد الطلب</h2>
                <button id="checkout-close" style="background: #eee; width: 30px; height: 30px; border-radius: 50%;"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="checkout-form">
                <div class="checkout-section">
                    <h3><i class="fas fa-user"></i> بياناتك</h3>
                    <div class="form-group">
                        <label>الاسم</label>
                        <input type="text" id="customer-name" class="form-control" required placeholder="أدخل اسمك">
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="tel" id="customer-phone" class="form-control" required placeholder="07xxxxxxxx">
                    </div>
                </div>

                <div class="checkout-section">
                    <h3><i class="fas fa-map-marker-alt"></i> التوصيل</h3>
                    <div class="form-group">
                        <label>المنطقة</label>
                        <select id="customer-area" class="form-control" required>
                            <option value="">اختر المنطقة</option>
                            <option value="صويلح">صويلح</option>
                            <option value="دابوق">دابوق</option>
                            <option value="خلدا">خلدا</option>
                            <option value="تلاع العلي">تلاع العلي</option>
                            <option value="ام السماق">ام السماق</option>
                            <option value="الجبيهة">الجبيهة</option>
                            <option value="المدينة الرياضية">المدينة الرياضية</option>
                            <option value="الرصيفة">الرصيفة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>حدد موقعك (اختياري)</label>
                        <div id="location-map" style="height: 150px; border-radius: 8px; margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" id="locate-me-btn" style="padding: 8px 15px; background: #eee; border-radius: 6px; font-size: 0.8rem;"><i class="fas fa-crosshairs"></i> موقعي الحالي</button>
                        </div>
                        <input type="hidden" id="customer-lat"><input type="hidden" id="customer-lng">
                    </div>
                    
                    <div class="form-group">
                        <textarea id="customer-notes" class="form-control" placeholder="ملاحظات توصيل إضافية..." style="height: 60px;"></textarea>
                    </div>
                </div>

                <div class="checkout-section">
                    <h3><i class="fas fa-receipt"></i> الفاتورة</h3>
                    <div id="order-items-summary" style="font-size: 0.9rem; color: #555; margin-bottom: 10px;"></div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px dashed #ccc; padding-top: 10px;">
                        <span>الإجمالي النهائي:</span>
                        <span id="order-final-price" style="color: var(--primary); font-size: 1.2rem;">0.00 د.أ</span>
                    </div>
                </div>

                <button type="submit" id="submit-order-btn" style="width: 100%; padding: 15px; background: var(--success); color: white; border-radius: 12px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);">
                    إرسال الطلب <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="track-order-modal">
        <div class="modal-sheet">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h2>تتبع الطلب</h2>
                <button id="track-close" style="background: #eee; width: 30px; height: 30px; border-radius: 50%;"><i class="fas fa-times"></i></button>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="track-input" class="form-control" placeholder="رقم الطلب">
                <button id="track-submit" style="background: var(--primary); color: white; padding: 0 20px; border-radius: 8px;">بحث</button>
            </div>
            <div id="track-result" style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 10px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="thank-you-modal">
        <div class="modal-sheet" style="align-items: center; text-align: center;">
            <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
            <h2 style="margin-bottom: 10px;">تم استلام طلبك!</h2>
            <p style="color: #666; margin-bottom: 20px;">رقم طلبك هو: <b id="new-order-id" style="color: var(--text-main); font-size: 1.2rem;"></b></p>
            <button onclick="location.reload()" style="padding: 10px 30px; background: var(--primary); color: white; border-radius: 50px;">عودة للرئيسية</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        // --- تهيئة المكتبات ---
        const swiper = new Swiper('.swiper', {
            loop: true, autoplay: { delay: 3000 },
            pagination: { el: '.swiper-pagination' }
        });

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOhgRpF5YZ5fochZrmTniCtK4ScUnAsx0",
            authDomain: "all-in-one-testing.firebaseapp.com",
            databaseURL: "https://all-in-one-testing-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "all-in-one-testing",
            storageBucket: "all-in-one-testing.firebasestorage.app",
            messagingSenderId: "1020817144764",
            appId: "1:1020817144764:web:79999a783418c2b3e309b9",
            measurementId: "G-BV2GP93MKN"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- المتغيرات العامة ---
        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('bakeryCart')) || [];
        let currentCategory = 'all';
        let deliveryPrices = {
            "صويلح": 2.00, "دابوق": 2.00, "خلدا": 2.00, "تلاع العلي": 2.50, "ام السماق": 2.50,
            "الكمالية": 2.50, "المدينة الرياضية": 2.50, "الجبيهة": 3.00, "الرصيفة": 9.00
        };
        let map, marker;

        // --- التشغيل المبدئي ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            updateCartDisplay();
            setupEvents();
            initMap();
        });

        // --- جلب المنتجات ---
        function fetchProducts() {
            const url = 'https://script.google.com/macros/s/AKfycbww7lcWs_0perJbphln6g3ocH0Zm7HqOqLn-MvLWw-bvlpN1foxvUSmCBNMinW0EiKo9A/exec';
            
            const cached = localStorage.getItem('productsData');
            const time = localStorage.getItem('productsTime');
            if (cached && time && (Date.now() - time < 300000)) {
                processData(JSON.parse(cached));
            } else {
                fetch(url).then(res => res.json()).then(data => {
                    localStorage.setItem('productsData', JSON.stringify(data));
                    localStorage.setItem('productsTime', Date.now());
                    processData(data);
                }).catch(err => {
                    document.getElementById('loading').innerHTML = 'خطأ في الاتصال';
                });
            }
        }

        function processData(data) {
            allProducts = data.filter(p => p.name).map(p => ({
                ...p,
                id: String(p.id || 'p_' + Math.random().toString(36).substr(2,9)), // تحويل ID لنص دائماً
                price: parseFloat(p.price),
                images: typeof p.images === 'string' ? p.images.split(',') : [p.image || ''],
                labels: typeof p.labels === 'string' ? p.labels.split(',') : []
            }));
            
            renderCategories();
            renderProducts(allProducts);
            document.getElementById('loading').style.display = 'none';
        }

        // --- الرسم (Rendering) ---
        function renderCategories() {
            const cats = ['all', ...new Set(allProducts.map(p => p.category).filter(Boolean))];
            const container = document.getElementById('categories-filter');
            container.innerHTML = cats.map(c => 
                `<button class="category-filter-btn ${c==='all'?'active':''}" onclick="filterCat('${c}')">
                    ${c==='all'?'الكل':c}
                </button>`
            ).join('');
        }

        // حل المشكلة 3: السكرول عند تغيير المجموعة
        window.filterCat = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.category-filter-btn').forEach(b => 
                b.classList.toggle('active', b.textContent.trim() === (cat==='all'?'الكل':cat))
            );
            const filtered = cat === 'all' ? allProducts : allProducts.filter(p => p.category === cat);
            renderProducts(filtered);
            
            // إعادة التوجيه لبداية القائمة
            const container = document.querySelector('.products-container');
            if(container) {
                const top = container.offsetTop - 80;
                window.scrollTo({ top: top, behavior: 'smooth' });
            }
        };

        function renderProducts(list) {
            const grid = document.getElementById('products-grid');
            if(list.length === 0) { grid.innerHTML = '<p style="padding:20px; text-align:center;">لا يوجد منتجات</p>'; return; }
            
            grid.innerHTML = list.map(p => `
                <div class="product-card" onclick="openProductModal('${p.id}')">
                    <div class="product-image">
                        <img src="${p.images[0]}" loading="lazy">
                    </div>
                    <div class="product-details">
                        <div class="product-name">${p.name}</div>
                        <div class="product-description">${p.description || ''}</div>
                        <div class="product-footer">
                            <div class="product-price">${p.price.toFixed(2)} د.أ</div>
                            <div class="add-to-cart-btn-mini" onclick="event.stopPropagation(); addToCartById('${p.id}')">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- السلة والمنطق ---
        window.addToCartById = (id) => {
            const p = allProducts.find(x => String(x.id) === String(id)); // مقارنة نصية صارمة
            if(p) addToCart(p);
        };

        function addToCart(product, qty = 1, note = '') {
            const exist = cart.find(x => String(x.id) === String(product.id) && x.note === note);
            if(exist) exist.quantity += qty;
            else cart.push({ 
                id: String(product.id), name: product.name, price: product.price, 
                image: product.images[0], quantity: qty, note: note 
            });
            
            localStorage.setItem('bakeryCart', JSON.stringify(cart));
            updateCartDisplay();
            showToast('تمت الإضافة للسلة');
            
            const fab = document.getElementById('floating-cart');
            fab.style.transform = 'scale(1.2)';
            setTimeout(() => fab.style.transform = 'scale(1)', 200);
        }

        function updateCartDisplay() {
            const totalItems = cart.reduce((a, b) => a + b.quantity, 0);
            const totalPrice = cart.reduce((a, b) => a + (b.price * b.quantity), 0);
            
            document.getElementById('floating-cart-count').innerText = totalItems;
            document.getElementById('cart-total-price').innerText = totalPrice.toFixed(2) + ' د.أ';
            document.getElementById('sticky-cart-total').innerText = totalPrice.toFixed(2) + ' د.أ';
            
            document.getElementById('sticky-checkout-btn').style.display = totalItems > 0 ? 'flex' : 'none';

            const container = document.getElementById('cart-items-container');
            if (cart.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">السلة فارغة</div>';
            } else {
                container.innerHTML = cart.map((item, idx) => `
                    <div style="background:white; padding:10px; border-radius:10px; margin-bottom:10px; display:flex; gap:10px; border:1px solid #eee;">
                        <img src="${item.image}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:0.9rem;">${item.name}</div>
                            ${item.note ? `<div style="font-size:0.75rem; color:var(--primary); background:#fffbeb; display:inline-block; padding:2px 5px; border-radius:4px;">${item.note}</div>` : ''}
                            <div style="color:#666; font-size:0.85rem;">${item.price.toFixed(2)} د.أ</div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                            <button onclick="removeItem(${idx})" style="color:red; font-size:0.8rem;"><i class="fas fa-trash"></i></button>
                            <div style="background:#f3f4f6; border-radius:20px; padding:2px 8px; font-weight:bold; font-size:0.9rem;">x${item.quantity}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.removeItem = (idx) => {
            cart.splice(idx, 1);
            localStorage.setItem('bakeryCart', JSON.stringify(cart));
            updateCartDisplay();
        };

        // --- المودال والتفاصيل (حل المشكلة 2) ---
        window.openProductModal = (id) => {
            const p = allProducts.find(x => String(x.id) === String(id)); // مقارنة نصية صارمة
            if(!p) return;
            
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <img src="${p.images[0]}" class="product-detail-img">
                <div class="product-detail-title">${p.name}</div>
                <div class="product-detail-desc">${p.description || ''}</div>
                <div style="font-size:1.4rem; font-weight:bold; color:var(--primary); margin-bottom:15px;">${p.price.toFixed(2)} د.أ</div>
                
                <label style="font-weight:bold; display:block; margin-bottom:5px;">ملاحظات خاصة (اختياري):</label>
                <textarea id="modal-note" class="product-note-area" placeholder="مثال: بدون سكر، زيادة تحمير..."></textarea>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="number" id="modal-qty" value="1" min="1" style="width:60px; text-align:center; border:1px solid #ddd; border-radius:8px; font-weight:bold;">
                    <button onclick="confirmAddModal('${p.id}')" style="flex:1; background:var(--primary); color:white; border-radius:12px; font-weight:bold;">إضافة للسلة</button>
                </div>
            `;
            document.getElementById('product-modal').classList.add('active');
        };

        window.confirmAddModal = (id) => {
            const p = allProducts.find(x => String(x.id) === String(id));
            const qty = parseInt(document.getElementById('modal-qty').value) || 1;
            const note = document.getElementById('modal-note').value.trim();
            
            addToCart(p, qty, note);
            document.getElementById('product-modal').classList.remove('active');
        };

        // --- إدارة النوافذ (Events) ---
        function setupEvents() {
            const toggleCart = () => document.getElementById('cart-sidebar').classList.toggle('active');
            document.getElementById('floating-cart').onclick = toggleCart;
            document.getElementById('cart-close').onclick = toggleCart;
            
            const openCheckout = () => {
                if(cart.length === 0) return showToast('السلة فارغة!', 'error');
                document.getElementById('cart-sidebar').classList.remove('active');
                document.getElementById('checkout-modal').classList.add('active');
                renderOrderSummary();
            };
            document.getElementById('checkout-btn').onclick = openCheckout;
            document.getElementById('sticky-inner-btn').onclick = openCheckout;
            
            document.querySelectorAll('.modal-close-btn').forEach(b => b.onclick = function() {
                this.closest('.modal-overlay').classList.remove('active');
            });
            document.getElementById('checkout-close').onclick = () => document.getElementById('checkout-modal').classList.remove('active');
            
            document.getElementById('track-order-btn').onclick = () => document.getElementById('track-order-modal').classList.add('active');
            document.getElementById('track-close').onclick = () => document.getElementById('track-order-modal').classList.remove('active');
            
            document.getElementById('checkout-form').onsubmit = (e) => {
                e.preventDefault();
                submitOrder();
            };
            
            document.getElementById('locate-me-btn').onclick = locateUser;
        }

        // --- Checkout Logic ---
        function renderOrderSummary() {
            const area = document.getElementById('customer-area').value;
            let delivery = deliveryPrices[area] || 0;
            
            const itemsTotal = cart.reduce((a,b) => a + (b.price*b.quantity), 0);
            
            let discount = 0;
            if (itemsTotal >= 15) discount = 3;
            else if (itemsTotal >= 10) discount = 2;
            if(discount > delivery) discount = delivery;

            const final = itemsTotal + delivery - discount;
            
            document.getElementById('order-items-summary').innerHTML = cart.map(i => 
                `<div>${i.name} (x${i.quantity}) - ${(i.price*i.quantity).toFixed(2)}</div>`
            ).join('');
            
            document.getElementById('order-final-price').innerText = final.toFixed(2) + ' د.أ';
        }
        
        document.getElementById('customer-area').onchange = renderOrderSummary;

        function submitOrder() {
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true; btn.innerHTML = 'جاري الإرسال...';
            
            const orderId = 'ORD-' + Math.floor(Math.random() * 1000000);
            const finalPrice = document.getElementById('order-final-price').innerText;
            
            const orderData = {
                orderId: orderId,
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                area: document.getElementById('customer-area').value,
                notes: document.getElementById('customer-notes').value,
                lat: document.getElementById('customer-lat').value,
                lng: document.getElementById('customer-lng').value,
                items: cart,
                total: finalPrice,
                date: new Date().toISOString(),
                status: 'received'
            };
            
            firebase.database().ref('orders').push(orderData).then(() => {
                localStorage.setItem('bakeryCart', '[]');
                cart = [];
                document.getElementById('new-order-id').innerText = orderId;
                document.getElementById('checkout-modal').classList.remove('active');
                document.getElementById('thank-you-modal').classList.add('active');
            }).catch(() => {
                showToast('حدث خطأ!', 'error');
                btn.disabled = false; btn.innerHTML = 'إعادة المحاولة';
            });
        }

        // --- Maps ---
        function initMap() {
            map = L.map('location-map').setView([31.95, 35.91], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([31.95, 35.91], {draggable:true}).addTo(map);
            
            const updateInput = (lat, lng) => {
                document.getElementById('customer-lat').value = lat;
                document.getElementById('customer-lng').value = lng;
            };
            
            marker.on('dragend', (e) => updateInput(e.target.getLatLng().lat, e.target.getLatLng().lng));
            map.on('click', (e) => {
                marker.setLatLng(e.latlng);
                updateInput(e.latlng.lat, e.latlng.lng);
            });
        }

        function locateUser() {
            if(!navigator.geolocation) return showToast('غير مدعوم');
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude, longitude} = pos.coords;
                map.setView([latitude, longitude], 15);
                marker.setLatLng([latitude, longitude]);
                document.getElementById('customer-lat').value = latitude;
                document.getElementById('customer-lng').value = longitude;
            });
        }

        function showToast(msg, type='success') {
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.borderRight = `4px solid ${type==='error'?'red':'var(--primary)'}`;
            t.innerHTML = `<i class="fas ${type==='error'?'fa-exclamation-circle':'fa-check'}"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

    </script>
</body>
</html>
